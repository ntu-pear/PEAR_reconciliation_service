# This workflow will build and deploy the PEAR Reconciliation Service to Production
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: Reconciliation Service CD

on:
  push:
    branches: ["main"]

permissions:
  contents: read

jobs:
  precheck:
    runs-on: [self-hosted, Linux, X64]
    steps:
      - name: Check kubectl permissions
        run: |
          echo "Checking Kubernetes permissions..."
          kubectl auth can-i delete deployments || (echo "No permission to delete deployments" && exit 1)
          kubectl auth can-i create deployments || (echo "No permission to create deployments" && exit 1)
      
      - name: Check Docker registry access
        run: |
          echo "Checking Docker registry access..."
          docker info || (echo "Docker not accessible" && exit 1)

  deploy:
    needs: precheck
    runs-on: [self-hosted, Linux, X64]
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Print working directory
        run: |
          pwd
          ls -la
          git status
      
      - name: Pre-deployment setup
        run: |
          echo "ðŸš€ Starting Reconciliation Service deployment to PRODUCTION"
          echo "Current time: $(date)"
          echo "Git commit: ${{ github.sha }}"
      
      - name: Create secret.yaml from GitHub Secrets
        run: |
          echo "Creating secret.yaml from GitHub secrets..."
          
          # Encode secrets to base64
          ACTIVITY_URL_B64=$(echo -n "${{ secrets.ACTIVITY_SERVICE_URL }}" | base64 -w 0)
          PATIENT_URL_B64=$(echo -n "${{ secrets.PATIENT_SERVICE_URL }}" | base64 -w 0)
          SCHEDULER_URL_B64=$(echo -n "${{ secrets.SCHEDULER_SERVICE_URL }}" | base64 -w 0)
          RABBITMQ_URL_B64=$(echo -n "${{ secrets.RABBITMQ_URL }}" | base64 -w 0)
          
          # Create secret.yaml with encoded values
          cat > ./k8s/secret.yaml << EOF
          apiVersion: v1
          kind: Secret
          metadata:
            name: reconciliation-secret
          type: Opaque
          data:
            ACTIVITY_SERVICE_URL: ${ACTIVITY_URL_B64}
            PATIENT_SERVICE_URL: ${PATIENT_URL_B64}
            SCHEDULER_SERVICE_URL: ${SCHEDULER_URL_B64}
            RABBITMQ_URL: ${RABBITMQ_URL_B64}
          EOF
          
          echo "âœ… secret.yaml created with encoded values"
      
      - name: Apply Kubernetes ConfigMap and Secret
        run: |
          echo "Applying ConfigMap and Secret..."
          kubectl apply -f './k8s/configmap.yaml'
          kubectl apply -f './k8s/secret.yaml'
          echo "âœ… ConfigMap and Secret applied"
      
      - name: Delete old deployment
        run: |
          echo "Deleting old deployment..."
          kubectl delete deployment.apps/reconciliation-prod service/reconciliation-service-prod --ignore-not-found=true
          echo "âœ… Old deployment deleted"
      
      - name: Delete old docker images
        run: |
          echo "Deleting old Docker images..."
          docker rmi reconciliation_service_prod --force || true
          docker rmi localhost:5000/reconciliation_service_prod --force || true
          echo "âœ… Old images deleted"
      
      - name: Build Docker image
        run: |
          echo "ðŸ”¨ Building new Reconciliation Service image..."
          docker build --no-cache -f Dockerfile -t reconciliation_service_prod .
          echo "âœ… Image built"
      
      - name: Tag Docker image
        run: |
          echo "Tagging Docker image..."
          docker tag reconciliation_service_prod:latest localhost:5000/reconciliation_service_prod:latest
          echo "âœ… Image tagged"
      
      - name: Push Docker image to local registry
        run: |
          echo "Pushing Docker image to localhost:5000..."
          docker push localhost:5000/reconciliation_service_prod:latest
          echo "âœ… Image pushed successfully"
          sleep 5
      
      - name: Deploying to Kubernetes
        run: |
          echo "ðŸ”„ Deploying Reconciliation Service to PRODUCTION..."
          kubectl apply -f './k8s/deployment-prod.yaml'
          echo "âœ… Deployment applied"
      
      - name: Monitor deployment
        run: |
          echo "â³ Monitoring deployment progress..."
          kubectl rollout status deployment/reconciliation-prod --timeout=300s
          echo "âœ… Deployment completed"
      
      - name: Verify deployment
        run: |
          echo "ðŸ” Verifying deployment..."
          
          # Wait for pods to be ready
          kubectl wait --for=condition=ready pod -l app=reconciliation-prod --timeout=180s
          
          # Get pod status
          echo "ðŸ“Š Pod status:"
          kubectl get pods -l app=reconciliation-prod
          
          echo "ðŸ¥ Checking service health..."
          sleep 10
          
          # Get the pod name
          POD_NAME=$(kubectl get pods -l app=reconciliation-prod -o jsonpath='{.items[0].metadata.name}')
          
          if [ -n "$POD_NAME" ]; then
            echo "Testing health endpoint on pod: $POD_NAME"
            kubectl exec $POD_NAME -- curl -f http://localhost:8000/health || echo "âš ï¸ Health check warning (service may still be starting)"
            
            # Verify environment variables are loaded (without showing sensitive values)
            echo "ðŸ” Verifying environment variables are loaded..."
            kubectl exec $POD_NAME -- sh -c 'env | grep -E "ACTIVITY_SERVICE_URL|PATIENT_SERVICE_URL|SCHEDULER_SERVICE_URL|RABBITMQ_URL" | sed "s/=.*/=***REDACTED***/"'
          else
            echo "âš ï¸ No pods found"
          fi
      
      - name: Display service information
        run: |
          echo "ðŸ“‹ Service Information:"
          kubectl get service reconciliation-service-prod
          
          echo ""
          echo "âœ… Deployment Summary:"
          echo "  - Service: Reconciliation Service"
          echo "  - Environment: PRODUCTION"
          echo "  - Internal URL: http://reconciliation-service-prod:8000"
          echo "  - Image: host.minikube.internal:5000/reconciliation_service_prod:latest"
          echo "  - Commit: ${{ github.sha }}"
          echo "  - Deployed at: $(date)"
      
      - name: Post-deployment
        if: always()
        run: |
          echo "ðŸŽ¯ Deployment process completed"
          
          # Show recent logs for troubleshooting
          echo "ðŸ“ Recent logs:"
          kubectl logs -l app=reconciliation-prod --tail=50 || echo "No logs available yet"
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Please check the logs above for details."
          
          # Show pod events
          echo "ðŸ“‹ Recent pod events:"
          kubectl get events --field-selector involvedObject.kind=Pod --sort-by='.lastTimestamp' | tail -20
