name: Reconciliation Service CD

on:
  push:
    branches: ["main"]

permissions:
  contents: read

jobs:
  deploy-production:
    if: github.ref == 'refs/heads/main'
    runs-on: [self-hosted, Linux, X64]
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Pre-deployment setup
        run: |
          echo "Starting Reconciliation Service deployment to PRODUCTION"
          echo "Current time: $(date)"
          echo "Git commit: ${{ github.sha }}"
      
      - name: Build and push new image
        run: |
          echo "üî® Building new Reconciliation Service image..."
          docker build --no-cache -f Dockerfile -t reconciliation_service_prod .
          docker tag reconciliation_service_prod:latest localhost:5000/reconciliation_service_prod:latest
          docker push localhost:5000/reconciliation_service_prod:latest
          echo "Image built and pushed successfully"
          sleep 5
      
      - name: Create/Update Kubernetes Secret from GitHub Secrets
        run: |
          echo "Creating Kubernetes secret from GitHub repository secrets..."
          
          # Delete existing secret if it exists (ignore errors if it doesn't)
          kubectl delete secret reconciliation-secrets-prod --ignore-not-found=true
          
          # Create new secret from GitHub secrets
          kubectl create secret generic reconciliation-secrets-prod \
            --from-literal=activity-service-url='${{ secrets.ACTIVITY_SERVICE_URL }}' \
            --from-literal=patient-service-url='${{ secrets.PATIENT_SERVICE_URL }}' \
            --from-literal=scheduler-service-url='${{ secrets.SCHEDULER_SERVICE_URL }}' \
            --from-literal=rabbitmq-url='${{ secrets.RABBITMQ_URL }}'
          
          echo "Kubernetes secret created successfully"
      
      - name: Deploy or update service
        run: |
          echo "Deploying Reconciliation Service to PRODUCTION..."
          
          if kubectl get deployment reconciliation-prod &> /dev/null; then
            echo "Existing deployment found - performing rolling update"
            
            # Apply the latest configuration (ConfigMap, Service, etc.)
            kubectl apply -f k8s/deployment-prod.yaml
            
            # Force a rolling update by updating image and restart annotation
            kubectl set image deployment/reconciliation-prod reconciliation=host.minikube.internal:5000/reconciliation_service_prod:latest
            kubectl patch deployment reconciliation-prod -p "{\"spec\":{\"template\":{\"metadata\":{\"annotations\":{\"kubectl.kubernetes.io/restartedAt\":\"$(date -Is)\"}}}}}"
            
            echo "Rolling update initiated"
            
          else
            echo "No existing deployment - deploying fresh"
            kubectl apply -f k8s/deployment-prod.yaml
          fi
      
      - name: Monitor deployment
        run: |
          echo "‚è≥ Monitoring deployment progress..."
          
          # Wait for deployment to complete
          kubectl rollout status deployment/reconciliation-prod --timeout=300s
          
          echo "‚úÖ Deployment completed"
      
      - name: Verify deployment
        run: |
          echo "üîç Verifying deployment..."
          
          # Wait for pods to be ready
          kubectl wait --for=condition=ready pod -l app=reconciliation-prod --timeout=180s
          
          # Get pod status
          echo "üìä Pod status:"
          kubectl get pods -l app=reconciliation-prod
          
          echo "üè• Checking service health..."
          # Give the service a moment to fully initialize
          sleep 10
          
          # Get the pod name
          POD_NAME=$(kubectl get pods -l app=reconciliation-prod -o jsonpath='{.items[0].metadata.name}')
          
          if [ -n "$POD_NAME" ]; then
            echo "Testing health endpoint on pod: $POD_NAME"
            kubectl exec $POD_NAME -- curl -f http://localhost:8000/health || echo "‚ö†Ô∏è Health check warning (service may still be starting)"
            
            # Verify environment variables are loaded (without showing sensitive values)
            echo "üîç Verifying environment variables are loaded..."
            kubectl exec $POD_NAME -- sh -c 'env | grep -E "ACTIVITY_SERVICE_URL|PATIENT_SERVICE_URL|SCHEDULER_SERVICE_URL|RABBITMQ_URL" | sed "s/=.*/=***REDACTED***/"'
          else
            echo "‚ö†Ô∏è No pods found"
          fi
      
      - name: Display service information
        run: |
          echo "üìã Service Information:"
          kubectl get service reconciliation-service-prod
          
          echo ""
          echo "‚úÖ Deployment Summary:"
          echo "  - Service: Reconciliation Service"
          echo "  - Environment: PRODUCTION"
          echo "  - Internal URL: http://reconciliation-service-prod:8000"
          echo "  - Image: host.minikube.internal:5000/reconciliation_service_prod:latest"
          echo "  - Commit: ${{ github.sha }}"
          echo "  - Deployed at: $(date)"
          
          echo ""
          echo "üîê Secrets Status:"
          kubectl get secret reconciliation-secrets-prod -o jsonpath='{.data}' | jq 'keys'
      
      - name: Post-deployment
        if: always()
        run: |
          echo "üéØ Deployment process completed"
          
          # Show recent logs for troubleshooting
          echo "üìù Recent logs:"
          kubectl logs -l app=reconciliation-prod --tail=50 || echo "No logs available yet"
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "Please check the logs above for details."
          
          # Show pod events
          echo "üìã Recent pod events:"
          kubectl get events --field-selector involvedObject.kind=Pod --sort-by='.lastTimestamp' | tail -20
