name: Reconciliation Service CD

on:
  push:
    branches: ["main", "staging"]

permissions:
  contents: read

jobs:
  deploy-staging:
    if: github.ref == 'refs/heads/main'
    runs-on: [self-hosted, Linux, X64]
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Pre-deployment setup
        run: |
          echo "Starting Reconciliation Service deployment to STAGING"
          echo "Current time: $(date)"
          echo "Git commit: ${{ github.sha }}"
      
      - name: Build and push new image
        run: |
          echo "Building new Reconciliation Service image..."
          docker build --no-cache -f Dockerfile -t reconciliation_service_dev .
          docker tag reconciliation_service_dev:latest localhost:5000/reconciliation_service_dev:latest
          docker push localhost:5000/reconciliation_service_dev:latest
          echo "Image built and pushed successfully"
          sleep 5
      
      - name: Deploy or update service
        run: |
          echo "Deploying Reconciliation Service..."
          
          if kubectl get deployment reconciliation-stg &> /dev/null; then
            echo "Existing deployment found - performing rolling update"
            
            # Apply the latest configuration (in case ConfigMap changed)
            kubectl apply -f k8s/deployment-stg.yaml
            
            # Force a rolling update by updating image and restart annotation
            kubectl set image deployment/reconciliation-stg reconciliation=host.minikube.internal:5000/reconciliation_service_dev:latest
            kubectl patch deployment reconciliation-stg -p "{\"spec\":{\"template\":{\"metadata\":{\"annotations\":{\"kubectl.kubernetes.io/restartedAt\":\"$(date -Is)\"}}}}}"
            
            echo "Rolling update initiated"
            
          else
            echo "No existing deployment - deploying fresh"
            kubectl apply -f k8s/deployment-stg.yaml
          fi
      
      - name: Monitor deployment
        run: |
          echo "Monitoring deployment progress..."
          
          # Wait for deployment to complete
          kubectl rollout status deployment/reconciliation-stg --timeout=300s
          
          echo "Deployment completed"
      
      - name: Verify deployment
        run: |
          echo "üîç Verifying deployment..."
          
          # Wait for pods to be ready
          kubectl wait --for=condition=ready pod -l app=reconciliation-stg --timeout=180s
          
          # Get pod status
          echo "Pod status:"
          kubectl get pods -l app=reconciliation-stg
          
          echo "Checking service health..."
          # Give the service a moment to fully initialize
          sleep 10
          
          # Get the pod name
          POD_NAME=$(kubectl get pods -l app=reconciliation-stg -o jsonpath='{.items[0].metadata.name}')
          
          if [ -n "$POD_NAME" ]; then
            echo "Testing health endpoint on pod: $POD_NAME"
            kubectl exec $POD_NAME -- curl -f http://localhost:8000/health || echo "‚ö†Ô∏è Health check warning (service may still be starting)"
          else
            echo "No pods found"
          fi
      
      - name: Display service information
        run: |
          echo "üìã Service Information:"
          kubectl get service reconciliation-service-stg
          kubectl get service reconciliation-service-stg-nodeport
          
          echo ""
          echo "Deployment Summary:"
          echo "  - Service: Reconciliation Service"
          echo "  - Environment: STAGING"
          echo "  - Internal URL: http://reconciliation-service-stg:8000"
          echo "  - NodePort: 30800 (for external access)"
          echo "  - Commit: ${{ github.sha }}"
          echo "  - Deployed at: $(date)"
      
      - name: Post-deployment
        if: always()
        run: |
          echo "Deployment process completed"
          
          # Show recent logs for troubleshooting
          echo "Recent logs:"
          kubectl logs -l app=reconciliation-stg --tail=50 || echo "No logs available yet"
